<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
<link rel="manifest" href="manifest.json">
<title>QR Code</title>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  html {
    color-scheme: light dark;
    background-color: #fff;
    color: #161616;
  }
  @media (prefers-color-scheme: dark) {
    html { background-color: #000; color: #fff; }
  }

  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    font: 18px / 1.5 system-ui;
    padding: 20px;
  }

  #qrcode {
    background: white;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 18px;
  }

  #qrcode svg {
    display: block;
    width: 100%;
    height: auto;
    max-width: 400px;
  }

  #nav {
    display: flex;
    gap: 18px;
    margin-top: 8px;
    opacity: 0.85;
    user-select: none;
  }

  #nav a {
    color: inherit;
    text-decoration: none;
    text-underline-offset: 6px;
    text-decoration-thickness: 1px;
  }

  #nav a:hover { text-decoration: underline; }

  #hint {
    margin-top: 10px;
    font: 13px / 1.4 system-ui;
    opacity: 0.7;
  }
</style>

<div id="qrcode"></div>

<div id="nav">
  <a id="lnk-edit" href="/">EDIT</a>
  <a id="lnk-md" href="/md">MD</a>
</div>

<div id="hint"></div>

<script>
  /* PASTE YOUR EXISTING HUGE qrcode LIBRARY HERE (unchanged) */
</script>

<script>
  function detectFrom() {
    // preferred: explicit query string
    const qs = new URLSearchParams(location.search)
    const fromParam = qs.get('from')
    if (fromParam === 'md' || fromParam === 'edit') return fromParam

    // fallback: referrer (handles proxies that strip querystrings)
    try {
      if (document.referrer) {
        const ref = new URL(document.referrer)
        if (ref.pathname === '/md' || ref.pathname === '/md.html') return 'md'
      }
    } catch (e) {}

    return 'edit'
  }

  function render() {
    const hash = location.hash || ''
    const from = detectFrom()

    // QR should point to EDIT or MD depending on where it was opened from
    const targetPath = (from === 'md') ? '/md' : '/'
    const url = new URL(targetPath + hash, location.origin).toString()

    // nav links preserve the hash
    document.getElementById('lnk-edit').href = '/' + hash
    document.getElementById('lnk-md').href = '/md' + hash

    // small hint so you can confirm behavior quickly
    document.getElementById('hint').textContent =
      'QR points to: ' + (from === 'md' ? 'MD viewer' : 'Editor')

    const typeNumber = 0
    const errorCorrectionLevel = 'L'
    const qr = qrcode(typeNumber, errorCorrectionLevel)
    qr.addData(url)
    qr.make()
    document.getElementById('qrcode').innerHTML = qr.createSvgTag({cellSize: 8, margin: 0})
  }

  render()

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
  }

  addEventListener('hashchange', render)
  addEventListener('popstate', render)
</script>
