<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
<link rel="manifest" href="manifest.json">
<title>Textarea</title>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  html {
    color-scheme: light dark;
    background-color: #fff;
    color: #161616;
  }
  @media (prefers-color-scheme: dark) {
    html { background-color: #000; color: #fff; }
  }

  header {
    position: sticky;
    top: 0;
    z-index: 10;
    padding: 14px 18px 6px;
    background: inherit;
    text-align: center;
    font: 14px / 1.4 system-ui;
    opacity: 0.85;
    user-select: none;
  }
  header a {
    color: inherit;
    text-decoration: none;
    margin: 0 10px;
    text-underline-offset: 6px;
  }
  header a:hover { text-decoration: underline; }

  article {
    padding: 12px max(18px, calc(50vw - 400px)) 18px;
    width: 100%;
    min-height: 100vh;
    font: 18px / 1.6 system-ui;
    tab-size: 4;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    overflow-wrap: break-word;
  }

  /* Markdown rendering styles */
  article > * { margin: 0.6em 0; }
  article h1 { font-size: 2em; font-weight: 800; margin: 0.7em 0 0.4em; }
  article h2 { font-size: 1.6em; font-weight: 800; margin: 0.7em 0 0.4em; }
  article h3 { font-size: 1.3em; font-weight: 800; margin: 0.7em 0 0.4em; }
  article h4 { font-size: 1.1em; font-weight: 800; margin: 0.7em 0 0.4em; }
  article h5 { font-size: 1.0em; font-weight: 800; margin: 0.7em 0 0.4em; }
  article h6 { font-size: 0.9em; font-weight: 800; margin: 0.7em 0 0.4em; }

  article p { margin: 0.6em 0; }
  article ul, article ol { padding-left: 1.4em; margin: 0.6em 0; }
  article li { margin: 0.2em 0; }

  article blockquote {
    padding-left: 0.9em;
    border-left: 4px solid currentColor;
    opacity: 0.85;
  }

  article code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size: 0.95em;
  }

  article pre {
    padding: 12px 14px;
    overflow: auto;
    border-radius: 12px;
    border: 1px solid rgba(127, 127, 127, 0.35);
  }

  article pre code { white-space: pre; }

  article a {
    color: #007bff;
    text-decoration: underline;
    word-break: break-word;
  }

  article table {
    border-collapse: collapse;
    width: 100%;
    overflow: auto;
    display: block;
  }
  article th, article td {
    border: 1px solid rgba(127, 127, 127, 0.35);
    padding: 8px 10px;
    text-align: left;
  }
</style>

<header>
  <a id="lnk-edit" href="/">EDIT</a>
  <a id="lnk-qr" href="/qr?from=md">QR</a>
</header>

<article></article>

<script src="vendor/markdown-it.min.js"></script>
<script src="vendor/purify.min.js"></script>

<script>
  const article = document.querySelector('article')

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
  }

  console.log('%cGitHub https://github.com/antonmedv/textarea', 'font-size: 16px; border: 1px solid lightblue; border-radius: 12px; padding: 10px 14px; ')

  const md = window.markdownit({
    html: false,
    linkify: true,
    typographer: true,
    breaks: false
  })

  addEventListener('DOMContentLoaded', load)
  addEventListener('hashchange', load)

  function updateLinks() {
    const hash = location.hash || ''
    document.getElementById('lnk-edit').href = '/' + hash
    document.getElementById('lnk-qr').href = '/qr?from=md' + hash
  }

  async function load() {
    try {
      let hash = location.hash

      if (!hash) {
        hash = localStorage.getItem('hash') ?? ''
        if (hash) history.replaceState({}, '', hash)
      } else {
        try { localStorage.setItem('hash', hash) } catch (e) {}
      }

      updateLinks()

      if (!hash) {
        article.innerHTML = ''
        document.title = 'Textarea'
        return
      }

      await renderFromHash(hash)
    } catch (e) {
      article.innerHTML = ''
      document.title = 'Textarea'
    }
  }

  async function renderFromHash(hash) {
    const decompressed = await decompress(hash.slice(1))
    const [content, style] = decompressed.split('\x00')

    updateTitleFromMarkdown(content || '')

    const rendered = md.render(content || '')
    article.innerHTML = DOMPurify.sanitize(rendered)

    if (style) article.setAttribute('style', style)
    else article.removeAttribute('style')
  }

  function updateTitleFromMarkdown(src) {
    const m = src.match(/^\s*#\s+(.+?)\s*$/m)
    document.title = m?.[1] ?? 'Textarea'
  }

  async function decompress(b64) {
    const byteArray = Uint8Array.fromBase64(b64, {alphabet: 'base64url'})
    const stream = new DecompressionStream('deflate-raw')
    const writer = stream.writable.getWriter()
    writer.write(byteArray)
    writer.close()
    const buffer = await new Response(stream.readable).arrayBuffer()
    return new TextDecoder().decode(buffer)
  }
</script>
